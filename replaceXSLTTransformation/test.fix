## New dmdSec with DC-Metadata

set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:title")
set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dcterms:alternative")

do list(path:"metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:titleInfo","var":"$i")
	if any_equal("$i.@type","alternative")
		copy_field("$i.mods:title.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dcterms:alternative.$append.value")
	else
		copy_field("$i.mods:title.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:title.$append.value")
	end
end

set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:creator")
set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:contributor")

do list(path:"metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:name","var":"$i")
	if any_equal("$i.mods:role.mods:roleTerm.value","aut")
		copy_field("$i.mods:displayForm.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:creator.$append.value")
	else
		copy_field("$i.mods:displayForm.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:contributor.$append.value")
	end
end

set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:type")

copy_field("metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:typeOfResource.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:type.$append.value")
copy_field("metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:genre.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:type.$append.value")
copy_field("metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:originInfo.*.mods:issuance.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:type.$append.value")

set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:publisher")
copy_field("metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:originInfo.*.mods:publisher.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:publisher.$append.value")

set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dcterms:issued")
set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:date")
do list(path: "metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:originInfo","var":"$i")
	do list(path: "$i.mods:dateIssued","var":"$j")
		if exists("$j.@keyDate")
			copy_field("$j.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:date.$append.value")
		else
			copy_field("$j.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dcterms:issued.$append.value")
		end
	end
end


set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:language")
copy_field("metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:language.mods:languageTerm.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:language.$append.value")

set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:description")
set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:identifier")
copy_field("metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:originInfo.*.mods:edition.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:description.$append.value")

do list(path: "metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:note","var":"$i")
	if any_equal("$i.@type","citation/reference")
		copy_field("$i.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:identifier.$append.value")
	else
		copy_field("$i.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:description.$append.value")
	end
end

do list(path: "metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:identifier","var":"$i")

	if any_match("$i.@type","^urn.*$")
		paste("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:identifier.$append.value","~https://nbn-resolving.org/","$i.value",join_char:"")
		copy_field("$i.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:identifier.$append.value")
	else
		paste("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:identifier.$append.value","$i.@type","~:","$i.value",join_char:"")
	end
end

paste("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:identifier.$append.value","~system:","mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:recordInfo.mods:recordIdentifier.value",join_char:"")

set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:format")
copy_field("metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:physicalDescription.mods:extent.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:format.$append.value")


set_array("mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:rights")
copy_field("metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:accessCondition.value","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:rights.$append.value")
copy_field("metadata.mets:mets.mets:dmdSec.mets:mdWrap.mets:xmlData.mods:mods.mods:accessCondition.@xlink:href","mets:dmdSec.mets:mdWrap.mets:xmlData.dc:record.dc:rights.$append.value")



# Restructure record

set_array("mets:amdSec")
move_field("metadata.mets:mets.mets:amdSec","mets:amdSec.$append")

# amdSec: ie-amd
add_field("mets:amdSec.$append.@ID","ie-amd")
add_field("mets:amdSec.$last.mets:sourceMD.mets:mdWrap.@MDTYPE","MODS")
move_field("metadata.mets:mets.mets:dmdSec","mets:amdSec.$last.mets:sourceMD.mets:mdWrap.mets:xmlData.mets:dmdSec")
move_field("metadata.mets:mets.mets:dmdSec","mets:amdSec.$last.mets:sourceMD.mets:mdWrap.mets:xmlData.mets:dmdSec")


add_field("mets:amdSec.$last.mets:rightsMD.@ID","ie-amd-rights")
add_field("mets:amdSec.$last.mets:rightsMD.mets:mdWrap.@MDTYPE","OTHER")
add_field("mets:amdSec.$last.mets:rightsMD.mets:mdWrap.@OTHERMDTYPE","dnx")
add_field("mets:amdSec.$last.mets:rightsMD.mets:mdWrap.mets:xmlData.dnx.section.@id","accessRightsPolicy")

retain("mets*")

